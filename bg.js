!function(e){function t(t){for(var n,i,a=t[0],c=t[1],u=t[2],l=0,h=[];l<a.length;l++)i=a[l],o[i]&&h.push(o[i][0]),o[i]=0;for(n in c)Object.prototype.hasOwnProperty.call(c,n)&&(e[n]=c[n]);for(d&&d(t);h.length;)h.shift()();return s.push.apply(s,u||[]),r()}function r(){for(var e,t=0;t<s.length;t++){for(var r=s[t],n=!0,a=1;a<r.length;a++){var c=r[a];0!==o[c]&&(n=!1)}n&&(s.splice(t--,1),e=i(i.s=r[0]))}return e}var n={},o={10:0,24:0},s=[];function i(t){if(n[t])return n[t].exports;var r=n[t]={i:t,l:!1,exports:{}};return e[t].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.e=function(e){var t=[],r=o[e];if(0!==r)if(r)t.push(r[2]);else{var n=new Promise(function(t,n){r=o[e]=[t,n]});t.push(r[2]=n);var s,a=document.createElement("script");a.charset="utf-8",a.timeout=120,i.nc&&a.setAttribute("nonce",i.nc),a.src=function(e){return i.p+"chunk-"+({}[e]||e)+".js"}(e);var c=new Error;s=function(t){a.onerror=a.onload=null,clearTimeout(u);var r=o[e];if(0!==r){if(r){var n=t&&("load"===t.type?"missing":t.type),s=t&&t.target&&t.target.src;c.message="Loading chunk "+e+" failed.\n("+n+": "+s+")",c.type=n,c.request=s,r[1](c)}o[e]=void 0}};var u=setTimeout(function(){s({type:"timeout",target:a})},12e4);a.onerror=a.onload=s,document.head.appendChild(a)}return Promise.all(t)},i.m=e,i.c=n,i.d=function(e,t,r){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)i.d(r,n,function(t){return e[t]}.bind(null,n));return r},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i.oe=function(e){throw console.error(e),e};var a=window.webpackJsonp=window.webpackJsonp||[],c=a.push.bind(a);a.push=t,a=a.slice();for(var u=0;u<a.length;u++)t(a[u]);var d=c;s.push([349,1]),r()}({167:function(e,t,r){var n=r(183),o=r(184);e.exports=function(e,t,r){var s=t&&r||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var i=(e=e||{}).random||(e.rng||n)();if(i[6]=15&i[6]|64,i[8]=63&i[8]|128,t)for(var a=0;a<16;++a)t[s+a]=i[a];return t||o(i)}},183:function(e,t){var r="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(r){var n=new Uint8Array(16);e.exports=function(){return r(n),n}}else{var o=new Array(16);e.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),o[t]=e>>>((3&t)<<3)&255;return o}}},184:function(e,t){for(var r=[],n=0;n<256;++n)r[n]=(n+256).toString(16).substr(1);e.exports=function(e,t){var n=t||0,o=r;return[o[e[n++]],o[e[n++]],o[e[n++]],o[e[n++]],"-",o[e[n++]],o[e[n++]],"-",o[e[n++]],o[e[n++]],"-",o[e[n++]],o[e[n++]],"-",o[e[n++]],o[e[n++]],o[e[n++]],o[e[n++]],o[e[n++]],o[e[n++]]].join("")}},188:function(e,t,r){"use strict";t.a=e=>{const t={version:2,type:"kit"};t.uid=e.uid,t.icon=e.icon,t.title=e.name,t.desc=e.about;const r=t.search={},n=r.torrentSelector={},o=r.onGetValue={};if(r.searchUrl=e.search_path,e.root_url&&(r.baseUrl=e.root_url),e.auth&&(r.loginUrl=e.auth),e.post&&(r.requestType="POST",r.requestData=e.post),e.encode&&(r.onBeforeRequest=[{name:"encode",type:"cp1251"}]),r.listItemSelector=e.items,e.charset&&(r.requestMimeType="text/html; charset="+e.charset),e.cat_alt&&(e.cat_attr="alt",e.cat_alt=void 0),e.auth_f&&(r.loginFormSelector=e.auth_f),(e.sf||e.sl)&&(r.listItemSplice=[e.sf||0,-(e.sl||0)]),n.title=e.tr_name,n.url={selector:e.tr_link,attr:"href"},e.cat_name&&(n.categoryTitle=e.cat_name,e.cat_attr&&(n.categoryTitle={selector:n.categoryTitle,attr:e.cat_attr}),e.cat_link&&(n.categoryUrl={selector:e.cat_link,attr:"href"})),e.tr_size){n.size=e.tr_size,e.size_attr&&(n.size={selector:n.size,attr:e.size_attr});const t=[];e.size_r&&void 0!==e.size_rp&&t.push({name:"replaceRe",re:e.size_r,text:e.size_rp}),e.s_c&&t.push("convertSize"),t.length&&(o.size=t)}if(e.tr_dl&&(n.downloadUrl={selector:e.tr_dl,attr:"href"}),e.seed&&(n.seed=e.seed,e.seed_r&&(o.seed=[{name:"replaceRe",re:e.seed_r,text:e.seed_rp}])),e.peer&&(n.peer=e.peer,e.peer_r&&(o.peer=[{name:"replaceRe",re:e.peer_r,text:e.peer_rp}])),e.date){n.date=e.date,e.date_attr&&(n.date={selector:n.date,attr:e.date_attr});const t=[];e.t_r&&t.push({name:"replaceRe",re:e.t_r,text:e.t_r_r}),e.t_t_r&&t.push("replaceToday"),e.t_m_r&&t.push("replaceMonth"),void 0!==e.t_f&&"-1"!==e.t_f&&t.push({name:"timeFormat",format:e.t_f}),t.length&&(o.date=t)}return t}},189:function(e,t,r){"use strict";r(87);const n=(e,t)=>{const r={selector:null,pipeline:[]};if(e)return Array.isArray(t)||(t=[]),"string"==typeof e&&(e={selector:e}),r.selector=e.selector,"number"==typeof e.childNodeIndex&&r.pipeline.push({name:"getChild",args:[e.childNodeIndex]}),e.attr?r.pipeline.push({name:"getAttr",args:[e.attr]}):e.prop?r.pipeline.push({name:"getProp",args:[e.prop]}):e.html?(r.pipeline.push({name:"getHtml"}),r.pipeline.push({name:"trim"})):(r.pipeline.push({name:"getText"}),r.pipeline.push({name:"trim"})),t.forEach(e=>{"convertSize"===e?r.pipeline.push({name:"legacySizeFormat"}):"replaceToday"===e?r.pipeline.push({name:"legacyReplaceToday"}):"replaceMonth"===e?r.pipeline.push({name:"legacyReplaceMonth"}):"replaceRe"===e.name?r.pipeline.push({name:"replaceRe",args:[e.re,e.text]}):"timeFormat"===e.name&&r.pipeline.push({name:"legacyParseDate",args:[e.format]})}),r};t.a=e=>{const t={version:3,type:"kit"},r=t.search={};r.url=e.search.searchUrl;const o=e.search.requestType;o&&(r.method=o.toUpperCase());const s=e.search.requestData;s&&("POST"===r.method?r.body=s:r.query=s);const i=e.search.onBeforeRequest;if(Array.isArray(i)&&i.some(e=>{if("encode"===e.name&&"cp1251"===e.type)return r.encoding=e.type,!0}),e.search.requestMimeType){const t=/charset=([^;]+)/.exec(e.search.requestMimeType);t&&(e.search.charset=t[1])}const a=t.auth={},c=e.search.loginUrl;c&&(a.url=c);const u=e.search.loginFormSelector;u&&(a.loginForm={selector:u});const d=t.selectors={};d.row=n(e.search.listItemSelector),t.search.listItemSplice&&(d.skipFromStart=e.search.listItemSplice[0],d.skipFromEnd=-1*e.search.listItemSplice[1]),e.search.onGetValue=e.search.onGetValue||{},d.categoryTitle=n(e.search.torrentSelector.categoryTitle,e.search.onGetValue.categoryTitle),d.categoryUrl=n(e.search.torrentSelector.categoryUrl,e.search.onGetValue.categoryUrl),d.categoryId=n(e.search.torrentSelector.categoryId,e.search.onGetValue.categoryId),d.title=n(e.search.torrentSelector.title,e.search.onGetValue.title),d.url=n(e.search.torrentSelector.url,e.search.onGetValue.url),d.size=n(e.search.torrentSelector.size,e.search.onGetValue.size),d.downloadUrl=n(e.search.torrentSelector.downloadUrl,e.search.onGetValue.downloadUrl),d.seeds=n(e.search.torrentSelector.seed,e.search.onGetValue.seed),d.peers=n(e.search.torrentSelector.peer,e.search.onGetValue.peer),d.date=n(e.search.torrentSelector.date,e.search.onGetValue.date),d.nextPageUrl=n(e.search.nextPageSelector,e.search.onGetValue.nextPageSelector);const l=t.description={};l.icon=e.icon,l.name=e.title,e.desc&&(l.description=e.desc),e.updateUrl&&(l.updateUrl=e.updateUrl),e.downloadUrl&&(l.downloadUrl=e.downloadUrl);const h=e.search.baseUrl;return h&&(l.url=h),l.version=e.tVersion,t}},319:function(e,t,r){"use strict";r.r(t);var n=r(188),o=r(189);r(87);const s=r(342);var i=e=>{const t=[];t.push("==UserScript==");const r=new URL(e.search.url),n=e.description||{};t.push(`@name ${n.name}`),n.description&&t.push(`@description ${n.description}`),n.icon&&t.push(`@icon ${n.icon}`),n.updateUrl&&t.push(`@updateURL ${n.updateUrl}`),n.downloadUrl&&t.push(`@downloadURL ${n.downloadUrl}`),n.url?t.push(`@trackerURL ${n.url}`):t.push(`@trackerURL ${r.protocol}//${r.hostname}`),n.version?t.push(`@version ${e.description.version}`):t.push("@version 1.0"),t.push(`@connect *://${r.hostname}`),t.push("@require exKit"),t.push("==/UserScript==");const o=[];return o.push(...t.map(e=>`// ${e}`)),o.push(""),o.push(`const code = ${s(e)};`),o.push(""),o.push("API_exKit(code);"),o.join("\n")};t.default=e=>{let t=JSON.parse(e);return 1===t.version&&(t=Object(n.a)(t)),2===t.version&&(t=Object(o.a)(t)),i(t)}},320:function(e,t,r){(function(t){var r="Expected a function",n=NaN,o="[object Symbol]",s=/^\s+|\s+$/g,i=/^[-+]0x[0-9a-f]+$/i,a=/^0b[01]+$/i,c=/^0o[0-7]+$/i,u=parseInt,d="object"==typeof t&&t&&t.Object===Object&&t,l="object"==typeof self&&self&&self.Object===Object&&self,h=d||l||Function("return this")(),p=Object.prototype.toString,f=Math.max,b=Math.min,m=function(){return h.Date.now()};function g(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function v(e){if("number"==typeof e)return e;if(function(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&p.call(e)==o}(e))return n;if(g(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=g(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(s,"");var r=a.test(e);return r||c.test(e)?u(e.slice(2),r?2:8):i.test(e)?n:+e}e.exports=function(e,t,n){var o,s,i,a,c,u,d=0,l=!1,h=!1,p=!0;if("function"!=typeof e)throw new TypeError(r);function y(t){var r=o,n=s;return o=s=void 0,d=t,a=e.apply(n,r)}function w(e){var r=e-u;return void 0===u||r>=t||r<0||h&&e-d>=i}function O(){var e=m();if(w(e))return R(e);c=setTimeout(O,function(e){var r=t-(e-u);return h?b(r,i-(e-d)):r}(e))}function R(e){return c=void 0,p&&o?y(e):(o=s=void 0,a)}function _(){var e=m(),r=w(e);if(o=arguments,s=this,u=e,r){if(void 0===c)return function(e){return d=e,c=setTimeout(O,t),l?y(e):a}(u);if(h)return c=setTimeout(O,t),y(u)}return void 0===c&&(c=setTimeout(O,t)),a}return t=v(t)||0,g(n)&&(l=!!n.leading,i=(h="maxWait"in n)?f(v(n.maxWait)||0,t):i,p="trailing"in n?!!n.trailing:p),_.cancel=function(){void 0!==c&&clearTimeout(c),d=0,o=u=s=c=void 0},_.flush=function(){return void 0===c?a:R(m())},_}}).call(this,r(50))},341:function(e,t,r){"use strict";var n,o="object"==typeof Reflect?Reflect:null,s=o&&"function"==typeof o.apply?o.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};n=o&&"function"==typeof o.ownKeys?o.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var i=Number.isNaN||function(e){return e!=e};function a(){a.init.call(this)}e.exports=a,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var c=10;function u(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function d(e,t,r,n){var o,s,i,a;if("function"!=typeof r)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof r);if(void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),i=s[t]),void 0===i)i=s[t]=r,++e._eventsCount;else if("function"==typeof i?i=s[t]=n?[r,i]:[i,r]:n?i.unshift(r):i.push(r),(o=u(e))>0&&i.length>o&&!i.warned){i.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+i.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=i.length,a=c,console&&console.warn&&console.warn(a)}return e}function l(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},o=function(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,s(this.listener,this.target,e))}.bind(n);return o.listener=r,n.wrapFn=o,o}function h(e,t,r){var n=e._events;if(void 0===n)return[];var o=n[t];return void 0===o?[]:"function"==typeof o?r?[o.listener||o]:[o]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(o):f(o,o.length)}function p(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function f(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");c=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||i(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return u(this)},a.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var n="error"===e,o=this._events;if(void 0!==o)n=n&&void 0===o.error;else if(!n)return!1;if(n){var i;if(t.length>0&&(i=t[0]),i instanceof Error)throw i;var a=new Error("Unhandled error."+(i?" ("+i.message+")":""));throw a.context=i,a}var c=o[e];if(void 0===c)return!1;if("function"==typeof c)s(c,this,t);else{var u=c.length,d=f(c,u);for(r=0;r<u;++r)s(d[r],this,t)}return!0},a.prototype.addListener=function(e,t){return d(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return d(this,e,t,!0)},a.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.on(e,l(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.prependListener(e,l(this,e,t)),this},a.prototype.removeListener=function(e,t){var r,n,o,s,i;if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);if(void 0===(n=this._events))return this;if(void 0===(r=n[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(o=-1,s=r.length-1;s>=0;s--)if(r[s]===t||r[s].listener===t){i=r[s].listener,o=s;break}if(o<0)return this;0===o?r.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(r,o),1===r.length&&(n[e]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",e,i||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var o,s=Object.keys(r);for(n=0;n<s.length;++n)"removeListener"!==(o=s[n])&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},a.prototype.listeners=function(e){return h(this,e,!0)},a.prototype.rawListeners=function(e){return h(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):p.call(e,t)},a.prototype.listenerCount=p,a.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]}},342:function(e,t,r){"use strict";var n=/("(?:[^\\"]|\\.)*")|[:,]/g;e.exports=function(e,t){var r,o,s;return t=t||{},r=JSON.stringify([1],void 0,void 0===t.indent?2:t.indent).slice(2,-3),o=""===r?1/0:void 0===t.maxLength?80:t.maxLength,s=t.replacer,function e(t,i,a){var c,u,d,l,h,p,f,b,m,g,v,y;if(t&&"function"==typeof t.toJSON&&(t=t.toJSON()),void 0===(v=JSON.stringify(t,s)))return v;if(f=o-i.length-a,v.length<=f&&(m=v.replace(n,function(e,t){return t||e+" "})).length<=f)return m;if(null!=s&&(t=JSON.parse(v),s=void 0),"object"==typeof t&&null!==t){if(b=i+r,d=[],u=0,Array.isArray(t))for(g="[",c="]",f=t.length;u<f;u++)d.push(e(t[u],b,u===f-1?0:1)||"null");else for(g="{",c="}",f=(p=Object.keys(t)).length;u<f;u++)l=p[u],h=JSON.stringify(l)+": ",void 0!==(y=e(t[l],b,h.length+(u===f-1?0:1)))&&d.push(h+y);if(d.length>0)return[g,r+d.join(",\n"+b),c].join("\n"+i)}return v}(e,"",0)}},349:function(e,t,r){r(29),e.exports=r(401)},401:function(e,t,r){"use strict";r.r(t);r(38),r(18),r(107),r(19),r(11);var n=r(4),o=r(163),s=r(3),i=r(26),a=r(29),c=r(56),u=r(0),d=r(12),l=r(32),h=r(85),p=r(110),f=r(10),b=r(9),m=(r(78),r(155)),g=r(320),v=r.n(g);function y(e,t,r,n,o,s,i){try{var a=e[s](i),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,o)}function w(e){return function(){var t=this,r=arguments;return new Promise(function(n,o){var s=e.apply(t,r);function i(e){y(s,n,o,i,a,"next",e)}function a(e){y(s,n,o,i,a,"throw",e)}i(void 0)})}}function O(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}const R=r(100),_=r(341),x=Object(s.a)("TabFetchBg"),L=!1;class T{constructor(e,t){this.tabFetchBg=e,this.tabId=t,this.requests=[],L&&x.debug("SenderTab constructor",this.tabId)}addRequest(e){L&&x.debug("SenderTab addRequest",this.tabId,e.id),this.requests.push(e),e.on("finish",()=>{const t=this.requests.indexOf(e);-1!==t&&this.requests.splice(t,1)})}destroy(){L&&x.debug("SenderTab destroy",this.tabId),this.requests.slice(0).forEach(e=>{e.destroy()})}}class U{constructor(e,t){O(this,"tabUpdatedListener",(e,t)=>{e===this.tabId&&t.url&&(L&&x.debug("OriginTab tabUpdatedListener",this.tabId,this.originUrl),this.requests.forEach(e=>{e.initSession()}))}),O(this,"closeOnIdleDebounce",v()(this.closeOnIdle.bind(this),250)),this.tabFetchBg=e,this.originUrl=t,this.tabId=null,this.requests=[],this.tabPromise=null,L&&x.debug("OriginTab constructor",this.tabId,this.originUrl)}addRequest(e){L&&x.debug("OriginTab addRequest",this.tabId,this.originUrl,e.id),this.requests.push(e),e.on("finish",()=>{const t=this.requests.indexOf(e);-1!==t&&this.requests.splice(t,1),this.requests.length||this.closeOnIdleDebounce()})}initTab(){return L&&x.debug("OriginTab createTab",this.tabId,this.originUrl),this.tabPromise?this.tabPromise:this.tabPromise=Promise.resolve().then(()=>this.tabFetchBg.isMobile?k(this.originUrl):S(this.originUrl)).then(e=>{this.tabId=e,this.addTabUpdatedListener()})}addTabUpdatedListener(){chrome.tabs.onUpdated.hasListener(this.tabUpdatedListener)||(L&&x.debug("OriginTab addTabUpdatedListener",this.tabId,this.originUrl),chrome.tabs.onUpdated.addListener(this.tabUpdatedListener))}removeTabUpdatedListener(){chrome.tabs.onUpdated.hasListener(this.tabUpdatedListener)&&(L&&x.debug("OriginTab removeTabUpdatedListener",this.tabId,this.originUrl),chrome.tabs.onUpdated.removeListener(this.tabUpdatedListener))}closeOnIdle(){this.requests.length||(L&&x.debug("OriginTab closeOnIdle",this.tabId,this.originUrl),this.tabFetchBg.deleteOriginTab(this.originUrl),chrome.tabs.remove(this.tabId))}destroy(){L&&x.debug("OriginTab destroy",this.tabId,this.originUrl),this.requests.slice(0).forEach(e=>{e.destroy()}),this.removeTabUpdatedListener()}}class j extends _{constructor(e,t,r,n,o){super(),this.tabFetchBg=e,this.originTab=t,this.id=r,this.url=n,this.options=o,this.sessionIndex=0,this.state="idle",this.handleResolve=null,this.handleReject=null,this.resultPromise=new Promise((e,t)=>{this.handleResolve=e,this.handleReject=t}).then(...Object(m.a)(()=>{this.state="finished",this.emit("finish")})),L&&x.debug("Request constructor",this.id)}init(){var e=this;return w(regeneratorRuntime.mark(function t(){return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:return L&&x.debug("Request init",e.id),"idle"===e.state&&(e.state="pending",e.initSession()),t.abrupt("return",e.resultPromise);case 3:case"end":return t.stop()}},t)}))()}initSession(){var e=this;return w(regeneratorRuntime.mark(function t(){var r;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if("finished"!==e.state){t.next=2;break}return t.abrupt("return");case 2:return L&&x.debug("Request initSession",e.id),r=++e.sessionIndex,t.abrupt("return",e.originTab.initTab().then(()=>{if(r===e.sessionIndex)return M(e.originTab.tabId,{file:"tabFetch.js",runAt:"document_start"})}).then(()=>{if(r!==e.sessionIndex)return;const t=new URL(e.originTab.originUrl).origin,n=new URL(e.url).origin===t;return M(e.originTab.tabId,{code:`(${function(e,t,r,n){try{return window.tabFetch(e,t,r,n),{result:!0}}catch(e){return{error:{message:e.message,stack:e.stack}}}}})(${E(e.id,e.url,e.options,n)})`,runAt:"document_start"}).then(e=>e[0])}).then(t=>{r===e.sessionIndex&&(t?t.error&&e.handleReject(R(t.error)):e.handleReject(new Error("tabFetch error")))},t=>{r===e.sessionIndex&&e.handleReject(t)}));case 5:case"end":return t.stop()}},t)}))()}handleResponse(e){L&&x.debug("Request handleResponse",this.id),e.error?this.handleReject(R(e.error)):this.handleResolve(e.result)}abort(e){L&&x.debug("Request abort",this.id),"pending"===this.state&&M(this.originTab.tabId,{code:`(${function(e){try{window.tabFetchAbort(e)}catch(e){x.error("tabFetchAbort error",e)}}})(${E(this.id)})`,runAt:"document_start"}),this.handleReject(e||new Error("Aborted"))}destroy(){L&&x.debug("Request destroy",this.id),this.abort(new Error("Destroyed"))}}const S=e=>new Promise(t=>chrome.windows.create({url:e,focused:!1,width:120,height:25,left:screen.availWidth,top:screen.availHeight,type:"popup"},t)).then(e=>{const t=e.tabs[0].id;return chrome.tabs.update(t,{muted:!0}),t}),k=e=>new Promise(t=>chrome.tabs.create({url:e,active:!1},t)).then(e=>{const t=e.id;return chrome.tabs.update(t,{muted:!0}),t}),M=(e,t)=>new Promise((r,n)=>{chrome.tabs.executeScript(e,t,e=>{const t=chrome.runtime.lastError;t?n(t):r(e)})}),P=e=>new Promise((t,r)=>{chrome.permissions.contains(e,e=>{const n=chrome.runtime.lastError;n?r(n):t(e)})}),I=e=>new Promise((t,r)=>{chrome.permissions.request(e,e=>{const n=chrome.runtime.lastError;n?r(n):t(e)})}).then(e=>{if(!e)throw new Error("Permissions is not granted")}),E=(...e)=>e.map(JSON.stringify).join(",");var q=class{constructor(){O(this,"tabRemoveListener",e=>{L&&x.debug("tabRemoveListener",e);const t=this.senderTabMap.get(e);t&&(t.destroy(),this.senderTabMap.delete(e)),this.originTabMap.forEach((t,r)=>{t.tabId===e&&(t.destroy(),this.originTabMap.delete(r))}),this.originTabMap.size||this.idRequestMap.size||this.removeRemovedTabListener()}),this.senderTabMap=new Map,this.originTabMap=new Map,this.idRequestMap=new Map,this.requestIndex=0,this.isMobile=/Mobile Safari\/(\d+)|Android (\d+)/.test(navigator.userAgent),L&&x.debug("constructor")}request(e,t,r,n){var o=this;return w(regeneratorRuntime.mark(function s(){var i,a,c,u;return regeneratorRuntime.wrap(function(s){for(;;)switch(s.prev=s.next){case 0:return L&&x.debug("request",e,t,r,n),i={permissions:["tabs"]},s.next=4,P(i);case 4:if(s.sent){s.next=8;break}return s.next=8,I(i);case 8:return o.senderTabMap.has(e)||o.senderTabMap.set(e,new T(o,e)),a=o.senderTabMap.get(e),o.originTabMap.has(t)||o.originTabMap.set(t,new U(o,t)),c=o.originTabMap.get(t),u=new j(o,c,++o.requestIndex,r,n),o.idRequestMap.set(u.id,u),u.on("finish",()=>{o.idRequestMap.delete(u.id)}),c.addRequest(u),a.addRequest(u),o.addRemovedTabListener(),s.abrupt("return",u.id);case 19:case"end":return s.stop()}},s)}))()}deleteOriginTab(e){this.originTabMap.delete(e)}addRemovedTabListener(){chrome.tabs.onRemoved.hasListener(this.tabRemoveListener)||(L&&x.debug("addRemovedTabListener"),chrome.tabs.onRemoved.addListener(this.tabRemoveListener))}removeRemovedTabListener(){chrome.tabs.onRemoved.hasListener(this.tabRemoveListener)&&(L&&x.debug("removeRemovedTabListener"),chrome.tabs.onRemoved.removeListener(this.tabRemoveListener))}initRequest(e){L&&x.debug("initRequest",e);const t=this.idRequestMap.get(e);if(t)return t.init();throw new Error(`initRequest error ${e} is not found`)}handleResponse(e,t){L&&x.debug("handleResponse",e);const r=this.idRequestMap.get(e);if(r)return r.handleResponse(t);throw new Error(`handleResponse error ${e} is not found`)}abortRequest(e){L&&x.debug("abortRequest",e);const t=this.idRequestMap.get(e);if(t)return t.abort();throw new Error(`initRequest error ${e} is not found`)}destroy(){L&&x.debug("destroy"),this.idRequestMap.forEach(e=>{e.destroy()}),this.senderTabMap.clear()}};const N=Object(s.a)("migrate");var F=function(){return Object(f.a)({migrate3:!1}).then(e=>{if(!e.migrate3)return Object(f.a)(null).then(function(e){const t={options:{},profiles:[]},r={trackers:{},migrate3:!0};return e.hasOwnProperty("contextMenu")&&(t.options.contextMenu=!!e.contextMenu),e.hasOwnProperty("hidePeerRow")&&(t.options.hidePeerRow=!!e.hidePeerRow),e.hasOwnProperty("hideSeedRow")&&(t.options.hideSeedRow=!!e.hideSeedRow),e.hasOwnProperty("invertIcon")&&(t.options.invertIcon=!!e.invertIcon),e.hasOwnProperty("kpFolderId")&&"string"==typeof e.kpFolderId&&(t.options.kpFolderId=e.kpFolderId),e.hasOwnProperty("disablePopup")&&(t.options.disablePopup=!!e.disablePopup),e.hasOwnProperty("categoryWordFilter")&&(t.options.categoryWordFilter=!!e.categoryWordFilter),e.hasOwnProperty("trackerListHeight")&&"number"==typeof trackerListHeight&&(t.options.trackerListHeight=e.trackerListHeight),e.hasOwnProperty("useEnglishPosterName")&&e.useEnglishPosterName?t.options.originalPosterName=!0:/^ru-?/.test(chrome.i18n.getUILanguage())||(t.options.originalPosterName=!0),function(e,t){const r=e.trackers,n=t.trackers;n&&Object.entries(n).forEach(([e,t])=>{try{r[e]={id:e,meta:Object(c.a)(t.code),info:{lastUpdate:0,disableAutoUpdate:!1},code:t.code}}catch(e){N.error("Migrate tracker error",e)}})}(r,e),function(e,t){const r=e.profiles,n=t.profiles;Array.isArray(n)&&n.forEach(e=>{r.push({id:`migrated-${e.id}`,name:e.name,trackers:e.trackers})})}(t,e),0===Object.keys(r.trackers).length&&delete r.trackers,0===Object.keys(t.options).length&&delete t.options,0===t.profiles.length&&delete t.profiles,Promise.all([Object(b.a)(r,"local"),Object(b.a)(t,"sync")])})})},A=r(120);const $=r(167);let C=null;var D=()=>C?Promise.resolve(C):Object(f.a)("uuid").then(e=>e.uuid?e.uuid:(e.uuid=$(),Object(b.a)(e).then(()=>e.uuid))).then(e=>C=e),V=r(319),z=r(146);function W(e,t,r,n,o,s,i){try{var a=e[s](i),c=a.value}catch(e){return void r(e)}a.done?t(c):Promise.resolve(c).then(n,o)}A.a.bindExceptions();const G=r(97),B=r(72),J=r(142),H=r(79),Y=Object(s.a)("background"),K=G(1);F();let Q=null;const X=o.a.create();X.fetchOptions().then(()=>{Object(n.autorun)(()=>{Z(X.options.invertIcon)}),Object(n.autorun)(()=>{ee(X.options.contextMenu)}),Object(n.autorun)(()=>{te(X.options.disablePopup)})}),chrome.omnibox.onInputEntered.addListener(e=>{re(e)}),chrome.runtime.onMessage.addListener(function(e,t,r){if(!e)return;let n=null;switch(e.action){case"downloadTracker":n=oe(e.id,e.updateURL,e.downloadURL);break;case"updateTracker":n=se(e.id);break;case"updateExplorerModule":n=ie(e.id);break;case"update":n=ne();break;case"search":Q||(Q=new q),n=Q.request(t.tab.id,e.origin,e.fetchUrl,e.fetchOptions);break;case"initSearch":n=Promise.resolve().then(()=>{if(Q)return Q.initRequest(e.id);throw new Error("TabFetchBg is not exists")});break;case"track":{const t=e.params;n=ue(t);break}case"abortSearch":Q&&Q.abortRequest(e.id);break;case"tabFetchResponse":Q&&Q.handleResponse(e.id,e.result)}return n?(n.then(e=>{r({result:e})},e=>{r({error:H(e)})}).catch(e=>{Y.error("Send response error",e)}),!0):void 0});const Z=e=>{e?chrome.action.setIcon({path:{19:"assets/icons/icon_19_i.png",38:"assets/icons/icon_38_i.png"}}):chrome.action.setIcon({path:{19:"assets/icons/icon_19.png",38:"assets/icons/icon_38.png"}})},ee=e=>{};const te=e=>{e?chrome.action.setPopup({popup:""}):chrome.action.setPopup({popup:"popup.html"})};chrome.action.onClicked.addListener(()=>{chrome.tabs.create({url:"index.html"})});const re=e=>{let t="index.html";e&&(t+="#/search?"+B.stringify({query:e})),chrome.tabs.create({url:t,selected:!0})},ne=()=>Object(f.a)({trackers:{},explorerModules:{}}).then(e=>{const t=[];Object.entries(e.trackers).forEach(([e,r])=>{try{i.b.create(r.options||{}).autoUpdate&&t.push(e)}catch(e){Y.error("Create TrackerMetaStore error",r.id)}});const r=[];return Object.entries(e.explorerModules).forEach(([e,t])=>{try{i.b.create(t.options||{}).autoUpdate&&r.push(e)}catch(e){Y.error("Create ExplorerModuleMetaStore error",t.id)}}),Promise.all([Promise.all(t.map(e=>se(e).then(t=>({id:e,result:t}),t=>(-1===["DOWNLOAD_URL_IS_EMPTY","NEW_VERSION_IS_NOT_FOUND"].indexOf(t.code)&&Y.error(`updateTracker ${e} error`,t),{id:e,error:H(t)})))),Promise.all(r.map(e=>ie(e).then(t=>({id:e,result:t}),t=>(-1===["DOWNLOAD_URL_IS_EMPTY","NEW_VERSION_IS_NOT_FOUND"].indexOf(t.code)&&Y.error(`updateExplorerModule ${e} error`,t),{id:e,error:H(t)}))))]).then(([e,t])=>({trackers:e,explorerModules:t}))}),oe=(e,t,r)=>K(()=>Promise.resolve().then(()=>t?ce(t,"tracker").then(({meta:e})=>e.downloadURL||r).catch(e=>(Y.error("getDownloadUrlFromUpdateUrl error",t,e),r)):r).then(e=>{if(!e)throw new d.b("downloadURL is empty","DOWNLOAD_URL_IS_EMPTY");return Object(a.fetch)(e).then(e=>{if(!e.ok)throw new d.b("bad response","BAD_RESPONSE");return e.text()}).then(e=>de(e)).then(t=>{const r=Object(c.a)(t);return r.downloadURL||(r.downloadURL=e,t=Object(z.a)(t,r)),{meta:r,code:t}})}).then(({code:t,meta:r})=>{const n=i.c.create({id:e,meta:r,code:t}),o=n.getSnapshot();return Object(u.c)(n),o.options.lastUpdate=Object(l.a)(),Object(f.a)({trackers:{}}).then(t=>(t.trackers[e]=o,Object(b.a)(t)))}).then(()=>!0)),se=e=>K(()=>Object(f.a)({trackers:{}}).then(t=>{const r=t.trackers[e],n=r.meta,o=n.updateURL,s=n.downloadURL,a=n.version;return ae(o,s,a,"tracker").then(t=>{const n=i.c.create({id:e,meta:Object(c.a)(t),code:t,options:r.options}),o=n.getSnapshot();if(Object(u.c)(n),!(J(o.meta.version,a)>0))throw new d.b("New version is not found","NEW_VERSION_IS_NOT_FOUND");return o.options.lastUpdate=Object(l.a)(),Object(f.a)({trackers:{}}).then(t=>(t.trackers[e]=o,Object(b.a)(t)))})}).then(()=>!0)),ie=e=>K(()=>Object(f.a)({explorerModules:{}}).then(t=>{const r=t.explorerModules[e],n=r.meta,o=n.updateURL,s=n.downloadURL,i=n.version;return ae(o,s,i,"explorerModule").then(t=>{const n=h.a.create({id:e,meta:Object(p.a)(t),code:t,options:r.options}),o=n.getSnapshot();if(Object(u.c)(n),!(J(o.meta.version,i)>0))throw new d.b("New version is not found","NEW_VERSION_IS_NOT_FOUND");return o.options.lastUpdate=Object(l.a)(),Object(f.a)({explorerModules:{}}).then(t=>(t.explorerModules[e]=o,Object(b.a)(t)))})}).then(()=>!0)),ae=function(){var e,t=(e=regeneratorRuntime.mark(function e(t,r,n,o){var s,i,a,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=null,i=null,!t){e.next=13;break}return e.prev=3,e.next=6,ce(t,o);case 6:a=e.sent,s=a.meta,e.next=13;break;case 10:e.prev=10,e.t0=e.catch(3),Y.error("getCodeAndMetaFromUrl from updateURL error",t,e.t0);case 13:if(s){e.next=21;break}if(r){e.next=16;break}throw new d.b("downloadURL is empty","DOWNLOAD_URL_IS_EMPTY");case 16:return e.next=18,ce(r,o);case 18:a=e.sent,s=a.meta,i=a.code;case 21:if(J(s.version,n)>0){e.next=24;break}throw new d.b("New version is not found in meta","NEW_VERSION_IS_NOT_FOUND");case 24:if(i){e.next=32;break}if(c=s.downloadURL||r){e.next=28;break}throw new d.b("downloadURL is empty","DOWNLOAD_URL_IS_EMPTY");case 28:return e.next=30,ce(c,o);case 30:a=e.sent,i=a.code;case 32:return e.abrupt("return",i);case 33:case"end":return e.stop()}},e,null,[[3,10]])}),function(){var t=this,r=arguments;return new Promise(function(n,o){var s=e.apply(t,r);function i(e){W(s,n,o,i,a,"next",e)}function a(e){W(s,n,o,i,a,"throw",e)}i(void 0)})});return function(e,r,n,o){return t.apply(this,arguments)}}(),ce=(e,t="tracker")=>Object(a.fetch)(e).then(e=>{if(!e.ok)throw new d.b("bad response","BAD_RESPONSE");return e.text()}).then(e=>de(e)).then(r=>{let n=null;return"tracker"===t?n=Object(c.a)(r):"explorerModule"===t&&(n=Object(p.a)(r)),n.downloadURL||(n.downloadURL=e,r=Object(z.a)(r,n)),{meta:n,code:r}}),ue=e=>Promise.resolve(),de=e=>{let t=e;if(/^\s*{/.test(e))try{t=Object(V.default)(e)}catch(e){Y.error("jsonCodeToUserscript error",e)}return t}}});